#### 4계층에서 하는 일
송신자의 프로세스와 수신자의 프로세스를 연결하는 통신 서비스. 내 메모리에서 동작중인 프로그램(프로세스)과 상대방 컴퓨터에서 동작중인 프로그램을 연결하기 위한 계층. 4계층엔 TCP 와 UDP 프로토콜이 있다.

TCP : 연결지향형 프로토콜. 연결이 되는지 확인하고 연결이 됐으면 데이터를 던진다.
UDP : 비 연결지향형 프로토콜. 연결을 하든 말든 데이터를 던진다.

#### 포트 번호
내 컴퓨터에서 사용하는 특정 프로그램이 사용하는 주소.
프로그램 하나가 포트번호 하나 사용 가능
A가 100번 포트 사용중이면 B는 다른 포트를 사용해야한다. 하지만 내 포트번호 하나는 하나의 프로그램만 실행 가능하지만 상대방 컴퓨터의 여러 프로그램들은 다 내 포트번호 하나랑 연결이 가능.

#### 포트번호의 종류
- Well-Known 포트 : 잘 알려진 포트. 웹이란 프로그램을 이용 할 땐 웹 브라우저라는 프로그램을 사용하는데 웹 서버 프로그램이랑 서로 연결이 된다. 이 때 웹 서버가 사용하는 포트번호가 80번. 0~1024번까지

|서비스 이름|포트 번호|
|----|----|
|FTP|20번, 21번|
|SSH|22번|
|TELNET|23번|
|DNS|53번|
|DHCP|67번, 68번|
|TFTP|69번|
|HTTP|80번|
|HTTPS|443번|


- Registered 포트 :  조금 유명한 포트. 오라클 DB 서버 - 1521번, MySQL서버 - 3306, MS 원격 데스크탑 - 3389번
- Dynamic 포트 : 우리들이 사용하는 포트번호. 49152 ~ 65535

우리가 크롬을 통하여 네이버라는 웹 서버와 연결이 될 때 시작 포트번호중에서 아무거나(49152)와 네이버(80)가 연결이 된다. 결국 인터넷을 사용하면 포트번호 쓰고 3계층주소 IP주소를 쓰고 2계층주소 MAC 주소를 사용한다.

#### UDP 프로토콜
사용자 데이터그램 프로토콜이며 유니버셜  데이터그램 프로토콜이라고도 한다. 상대방과 연결된 상태에서 데이터를 전송하는 것이 아니기 때문에  전송 방식이 매우 단순하여 신뢰성이  낮고 누락 가능성이 있다. 일반적으로 오류의 검사와 수정이 필요  없는 프로그램에서 수행할것으로 가정한다.

#### UDP 프로토콜 주소
출발지 포트번호(2바이트 ~65535) | 목적지 포트번호(2바이트)
길이(UDP프로토콜 헤더길이 8바이트 + 페이로드길이) | Checksum (프로토콜이 잘못됏는지 확인)
총 8바이트.

#### UDP를 사용하는 대표 프로그램
- DNS 서버 : 도메인을 물으면 IP를 알려주는 서버. 우리가 www.naver.com이라고 도메인 주소를 입력하면 이 도메인 주소의 IP주소를 알려줌.
- tftp : 파일 공유
- RIP 프로토콜 : 라우팅 정보를 공유하는 프로토콜


#### TCP 프로토콜
연결을 지향하기 때문에 UDP보다는 안정적인 통신을 제공한다. 데이터를 안정적으로 순서대로 에러없이 전달 할 수 있게 해준다. 일반적으로 통신할 경우 TCP IPv4 Ethernet 프로토콜 3가지를 사용한다. TCP는 안전하게 전달할려고 여러 기능을 사용하기때문에 UDP보다 조금 느리지만 체감x.
#### TCP 프로토콜의 구조

|             |                       |                            |                  |     |
| ----------- | --------------------- | -------------------------- | ---------------- | --- |
| Byte Offset | 0                     | 1                          | 2                | 3   |
| 0           | Source Port           | -                          | Destination Port | -   |
| 4           | Sequence Number       | -                          | -                | -   |
| 8           | Acknowledgment Number | -                          | -                | -   |
| 12          | Offset/Reserved       | TCP Flags C E U A P R S F  | Window           | -   |
| 16          | Checksum              | -                          | Urgent Pointer   | -   |
| 20          | TCP Options ~         | (variable length,optional) | -                | -   |


**Offset**은 header의 길이.(똑같이 4로 나눔).
**Reserved** 예약된필드. 사용하지 않음.
**Window** 상대방한테 데이터 줄 때 허락을 받고 얼마만큼 더 보낼지 알려주는 것. 내 남아있는 TCP 버퍼를 알려주는 것
**TCP Options** 은 IP프로토콜 Option처럼 잘 안 붙고 붙어도 4바이트씩 붙는다 (총 10개까지. 일반적으로 20바이트지만 60바이트까지 늘어날 수 있음)

TCP 플래그 : U A P R S F 만 알면 된다. TCP는 통신하면서 상대방이랑 연결상태를 물어보는데 그 때 나타내는 값이다. 어떤 플래그를 세팅해서 보내는지에 따라서 물어보는건지, 데이터 보내도 되는지 대답, 연결종료인지, 연결 초기화인지, 데이터를 보내는건지, 급한데이턴지 등등 지정하는 값이 플래그이다.

#### TCP 플래그 종류
Urgent flag : 우선순위가 높은 데이터가 포함되어있다. U가 1이면 급한 데이터다. Urgent Pointer랑 세트이다.
**Ack flag** : 승인비트. 데이터 보내도 되는지 물어보는 것에 대해 응답해주는 플래그. 
Push flag : 밀어넣기비트. TCP버퍼가 일정 크기만큼 쌓여야 전송하는데 이거랑 상관없이 계속해서 데이터를 밀어넣겠다는 flag
**Reset flag** : 초기화 비트. 상대방과 연결되어있는 상태에서 데이터를 주고받을 때 문제가 발생하여 reset하자는 flag
**Sync flag** : 동기화비트.  상대방이랑 연결을 시작 할 때 무조건 사용하는 flag. Sync flag가 처음 보내진 후 부터 둘 사이의 연결이 동기화 됨
**Fin flag** : 종료비트. 연결을 끊을 때 사용하는 flag.
##### 플래그의 생김새 
.... ..0. .... U
.... ...0 .... A
.... .... 0... O
.... .... .0.. R
S
F

#### TCP를 이용한 통신과정
**연결 수립 과정** : 둘 사이의 연결을 수립하는 과정이 중요. TCP를 이용한 통신을 할 때 프로세스와 프로세스를 연결하기 위해 가장 먼저 수행되는 과정
1. 클라이언트가 서버에게 요청 패킷을 보냄. 서버가 클라이언트에 보내는경우는 거의 없다.
2. 서버가 클라이언트의 요청을 받아들이는 패킷을 보내고
3. 클라이언트는 이를 최종적으로 수락하는 패킷을 보낸다.
- 위의 3개의 과정을 3Way Handshake라고 부른다.

ex) 3Way Handshake의 예제
1. 클라이언트가 Eth|IPv4|TCP 패킷을 만들어서  웹 서버에 보낸다. 
	(Flag : SYN S : 100, A : 0)
2. 서버가 요청을 받았으면 디캡슐화하여 내용을 확인한다.
3. 요청 왔다는걸 확인하고 답장하는 패킷을 만들어서 보낸다 
	(Flag : SYN+ACK S : 2000 A:101)
4. 클라이언트는 Sync와 Ack를 보고 요청을 수락하는 패킷을 보낸다 
	(Flag : ACK S:101 A:2001)

2-A 번호는 답장을 줄 때 받은 S 번호 +1를 한다. (101)
2-S 번호는 처음 보낼 때 자기만의 랜덤한 값을 생성한다. (2000)
3-A 번호는 받은 S번호 +1 한다. (2001)
3-S 